<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Trials of True Love ‚ù§Ô∏è - v1.5.6</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Pinyon+Script&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --gold: #b8860b;
            --ivory: #f9f6f0;
            --ink: #2a241e;
            --red: #d00000;
        }

        body {
            margin: 0;
            padding: 0;
            background: #e0d8cc;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
        }

        #snackbar {
            visibility: hidden;
            min-width: 400px;
            background-color: var(--ivory);
            color: var(--ink);
            text-align: center;
            border-radius: 8px;
            padding: 24px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: 50px;
            transform: translateX(-50%);
            border: 2px solid var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #snackbar.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        .valentine-panel {
            background: var(--ivory);
            background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
            border-radius: 12px;
            padding: 30px 60px;
            width: 1000px;
            height: 1250px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            color: var(--ink);
            border: 2px solid rgba(184, 134, 11, 0.4);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            text-align: center;
            pointer-events: auto !important;
            position: relative;
            overflow: hidden;
        }

        .valentine-panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            background: linear-gradient(to top, rgba(249, 246, 240, 0.95), rgba(249, 246, 240, 0));
            pointer-events: none;
            z-index: 1;
        }

        .ui-button {
            padding: 22px 45px;
            background: var(--ink);
            color: var(--ivory);
            border: 1px solid var(--gold);
            border-radius: 6px;
            font-family: 'Cinzel', serif;
            font-size: 28px;
            cursor: pointer;
            transition: 0.15s;
            display: inline-block;
            pointer-events: auto !important;
            position: relative;
        }

        .ui-button.secondary {
            background: var(--gold);
            color: white;
            border: none;
        }

        .ui-button:hover {
            background: var(--red);
            transform: translateY(-3px);
        }

        .form-group {
            text-align: left;
            width: 100%;
            position: relative;
            z-index: 2;
        }

        .form-group label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 26px;
            color: var(--ink);
            font-weight: 700;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(42, 36, 30, 0.1);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 18px;
            font-size: 30px;
            border-radius: 8px;
            font-family: 'Playfair Display', serif;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(42, 36, 30, 0.2);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 8px;
            max-height: 160px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 10px;
        }

        .avatar-grid img {
            width: 100%;
            aspect-ratio: 1/1;
            border: 2px solid var(--gold);
            cursor: pointer;
            background: #fff;
            filter: sepia(0.3);
            transition: 0.2s;
        }

        .avatar-grid img.active {
            border: 5px solid var(--red);
            transform: scale(1.05);
            filter: sepia(0);
        }

        .url-container {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 2px dashed var(--gold);
            padding: 25px;
            cursor: pointer;
            position: relative;
            z-index: 10;
            margin-top: 20px;
        }

        .copy-icon-box {
            position: absolute;
            top: -20px;
            left: -20px;
            background: var(--red);
            border-radius: 50%;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .copy-svg {
            width: 35px;
            height: 35px;
            fill: white;
        }

        #finalUrl {
            width: 100%;
            font-size: 20px;
            word-break: break-all;
            font-family: monospace;
            text-align: left;
            color: var(--ink);
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(184, 134, 11, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(184, 134, 11, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(184, 134, 11, 0);
            }
        }

        .meter-pulse {
            animation: pulse-gold 1.5s infinite;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 50px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 50px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="phaser-game"></div>
    <div id="snackbar">Link Secured! ‚ù§Ô∏è</div>

    <script>
        const AVATAR_LIST = ['Liam', 'Oliver', 'Jack', 'Leo', 'Milo', 'Felix', 'Max', 'Jude', 'Finn', 'Arlo', 'Ryker', 'Andrea', 'Sarah', 'Emma', 'Mia', 'Luna', 'Lily', 'Zoe'];
        const BRANDING_TEXT = "v1.5.6 ¬© 2026 coding-interface";

        const LANG_DATA = {
            en: { title: "Trials of True Love", sub: "The Eternal Missive", proposer: "Admirer Name", beloved: "Beloved's Name", myL: "Your Language", ptL: "Partner's Language", msg: "Message", msgDef: "Will you be my Valentine?", seal: "SEAL WITH A KISS üíå", appS: "SHARE APP üîó", ruleT: "The Affection Trial", ruleSub: "Instructions", ruleMove: "Slide left or right to catch treasures.", ruleCatch: "Gather these to fill the Meter:", ruleAvoid: "SHUN THESE at all costs:", ruleWarn: "Missing Love drains Affection!", begin: "I ACCEPT THE TRIAL üïäÔ∏è", score: "Affection Score", toMy: "To My Dearest", from: "A Message from", protect: "Protect Our Flame üíû", overwhelmed: "Love Overwhelmed", best: "Highest Affection", renew: "üîÑ Try Again", share: "üì¢ Share Score", forge: "‚ú® Create New", exit: "üïäÔ∏è Exit", accept: "YES! üòç", decline: "No", forever: "Forever Yours" },
            es: { title: "Pruebas de Amor", sub: "La Misiva Eterna", proposer: "Nombre del Admirador", beloved: "Nombre de la Pareja", myL: "Tu Idioma", ptL: "Idioma de Pareja", msg: "Mensaje", msgDef: "¬øQuieres ser mi San Valent√≠n?", seal: "SELLAR CON BESO üíå", appS: "COMPARTIR APP üîó", ruleT: "La Prueba de Afecto", ruleSub: "Instrucciones", ruleMove: "Desliza para atrapar tesoros.", ruleCatch: "Atrapa esto para el medidor:", ruleAvoid: "EVITA a toda costa:", ruleWarn: "¬°Perder un ‚ù§Ô∏è agota el afecto!", begin: "ACEPTO EL DESAF√çO üïäÔ∏è", score: "Puntuaci√≥n de Afecto", toMy: "Para mi Querida/o", from: "Un mensaje de", protect: "Protege Nuestra Llama üíû", overwhelmed: "Amor Superado", best: "M√°ximo Afecto", renew: "üîÑ Reiniciar", share: "üì¢ Compartir", forge: "‚ú® Crear Nuevo", exit: "üïäÔ∏è Salir", accept: "¬°S√ç! üòç", decline: "No", forever: "Tuyo por Siempre" },
            hi: { title: "‡§∏‡§ö‡•ç‡§ö‡•á ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ", sub: "‡§∂‡§æ‡§∂‡•ç‡§µ‡§§ ‡§™‡•ç‡§∞‡•á‡§Æ ‡§∏‡§Ç‡§¶‡•á‡§∂", proposer: "‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ", beloved: "‡§™‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ", myL: "‡§Ü‡§™‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ", ptL: "‡§∏‡§æ‡§•‡•Ä ‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ", msg: "‡§∏‡§Ç‡§¶‡•á‡§∂", msgDef: "‡§ï‡•ç‡§Ø‡§æ ‡§§‡•Å‡§Æ ‡§Æ‡•á‡§∞‡•Ä ‡§µ‡•à‡§≤‡•á‡§Ç‡§ü‡§æ‡§á‡§® ‡§¨‡§®‡•ã‡§ó‡•Ä?", seal: "‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§Æ‡•Å‡§π‡§∞ ‡§≤‡§ó‡§æ‡§è‡§Ç üíå", appS: "‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç üîó", ruleT: "‡§∏‡•ç‡§®‡•á‡§π ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ", ruleSub: "‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂", ruleMove: "‡§¨‡§æ‡§è‡§Ç ‡§Ø‡§æ ‡§¶‡§æ‡§è‡§Ç ‡§ñ‡§ø‡§∏‡§ï‡•á‡§Ç‡•§", ruleCatch: "‡§Æ‡•Ä‡§ü‡§∞ ‡§≠‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§®‡•ç‡§π‡•á‡§Ç ‡§™‡§ï‡§°‡§º‡•á‡§Ç:", ruleAvoid: "‡§á‡§®‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç:", ruleWarn: "‚ù§Ô∏è ‡§õ‡•ã‡§°‡§º‡§®‡•á ‡§∏‡•á ‡§∏‡•ç‡§®‡•á‡§π ‡§ï‡§Æ ‡§π‡•ã‡§ó‡§æ!", begin: "‡§Æ‡•Å‡§ù‡•á ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§π‡•à üïäÔ∏è", score: "‡§∏‡•ç‡§®‡•á‡§π ‡§Ö‡§Ç‡§ï", toMy: "‡§Æ‡•á‡§∞‡•á ‡§™‡•ç‡§∞‡§ø‡§Ø", from: "‡§ï‡•Ä ‡§ì‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§¶‡•á‡§∂", protect: "‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡•ã ‡§¨‡§ö‡§æ‡§è‡§Ç üíû", overwhelmed: "‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§π‡§æ‡§∞", best: "‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§† ‡§∏‡•ç‡§®‡•á‡§π", renew: "üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ñ‡•á‡§≤‡•á‡§Ç", share: "üì¢ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç", forge: "‚ú® ‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç", exit: "üïäÔ∏è ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡•á‡§Ç", accept: "‡§π‡§æ‡§Å! üòç", decline: "‡§®‡§π‡•Ä‡§Ç", forever: "‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ" }
        };

        function showSnackbar(msg) {
            const sb = document.getElementById("snackbar");
            sb.innerText = msg;
            sb.className = "show";
            setTimeout(() => { sb.className = ""; }, 3000);
        }

        class FormScene extends Phaser.Scene {
            constructor() { super('FormScene'); }
            create() {
                this.add.graphics().fillGradientStyle(0xe0d8cc, 0xe0d8cc, 0xf9f6f0, 0xf9f6f0, 1).fillRect(0, 0, 1080, 1920);
                this.createRomanticParticles();
                this.renderForm('en');
                // FOOTER: Game Scene
                this.add.text(540, 1880, BRANDING_TEXT, { fontFamily: 'Cinzel', fontSize: '24px', fill: '#2a241e' }).setOrigin(0.5).setAlpha(0.6).setDepth(10000);

            }

            createRomanticParticles() {
                for (let i = 0; i < 30; i++) {
                    const heart = this.add.text(Phaser.Math.Between(0, 1080), Phaser.Math.Between(0, 1920), '‚ù§Ô∏è', { fontSize: Phaser.Math.Between(20, 50) + 'px' });
                    heart.setTint(0xffb6c1).setAlpha(Phaser.Math.FloatBetween(0.1, 0.3));
                    this.tweens.add({ targets: heart, y: heart.y - 150, alpha: 0, duration: Phaser.Math.Between(3000, 6000), repeat: -1, ease: 'Sine.easeOut' });
                }
            }

            renderForm(langKey) {
                if (this.form) this.form.destroy();
                const t = LANG_DATA[langKey] || LANG_DATA.en;
                const html = `<div class="valentine-panel">
                    <h2 style="font-family:'Cinzel'; font-size:55px; margin:0;">${t.title}</h2>
                    <p style="font-family:'Pinyon Script'; font-size:38px; color:var(--gold);">${t.sub}</p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:35px;">
                        <div class="form-group"><label>${t.myL}</label><select id="fLang"><option value="en">English</option><option value="es">Espa√±ol</option><option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option></select></div>
                        <div class="form-group"><label>${t.ptL}</label><select id="pLang"><option value="en">English</option><option value="es">Espa√±ol</option><option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option></select></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:35px;">
                        <div class="form-group"><label>${t.proposer}</label><input type="text" id="cID" placeholder="${t.proposer}"></div>
                        <div class="form-group"><label>${t.beloved}</label><input type="text" id="pName" placeholder="${t.beloved}"></div>
                    </div>
                    <div class="form-group"><label>${t.msg}</label><textarea id="pMsg" rows="1">${t.msgDef}</textarea></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:35px;">
                        <div class="form-group"><label>Proposer Avatar</label><div class="avatar-grid" id="pro-av"></div></div>
                        <div class="form-group"><label>Beloved Avatar</label><div class="avatar-grid" id="bel-av"></div></div>
                    </div>
                    <input type="hidden" id="pAvatar" value="Andrea"><input type="hidden" id="cAvatar" value="Liam">
                    <div class="button-stack">
                        <button id="genBtn" class="ui-button">${t.seal}</button>
                        <button id="appShareBtn" class="ui-button secondary">${t.appS}</button>
                    </div>
                    <div id="shareSection" style="display:none;">
                        <div class="url-container" id="copyWrapper">
                            <div class="copy-icon-box"><svg class="copy-svg" viewBox="0 0 24 24"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/></svg></div>
                            <div id="finalUrl"></div>
                        </div>
                    </div>
                </div>`;
                this.form = this.add.dom(540, 960).createFromHTML(html);
                document.getElementById('fLang').value = langKey;

                const pLangSelect = document.getElementById('pLang');
                const proposerInput = document.getElementById('cID');
                const belovedInput = document.getElementById('pName');
                const msgInput = document.getElementById('pMsg');

                pLangSelect.onchange = (e) => {
                    const selectedPLang = e.target.value;
                    const pT = LANG_DATA[selectedPLang];
                    proposerInput.placeholder = pT.proposer;
                    belovedInput.placeholder = pT.beloved;
                    if (Object.values(LANG_DATA).some(ld => ld.msgDef === msgInput.value)) {
                        msgInput.value = pT.msgDef;
                    }
                };

                document.getElementById('fLang').onchange = (e) => this.renderForm(e.target.value);
                this.setupAvatarGrid('pro-av', 'cAvatar', 'Liam');
                this.setupAvatarGrid('bel-av', 'pAvatar', 'Andrea');

                document.getElementById('genBtn').onclick = async () => {
                    const safeMessage = (msgInput.value || '').replace(/\r\n|\n|\r/g, ' ');
                    const data = { l: pLangSelect.value, cid: proposerInput.value || "Admirer", n: belovedInput.value || "Love", av: document.getElementById('pAvatar').value, cav: document.getElementById('cAvatar').value, m: safeMessage };
                    const jsonStr = JSON.stringify(data);
                    const utf8bytes = new TextEncoder().encode(jsonStr);
                    const binary = Array.from(utf8bytes).map(b => String.fromCharCode(b)).join('');
                    const encoded = btoa(binary);
                    const url = window.location.origin + window.location.pathname + '?game=' + encodeURIComponent(encoded);
                    document.getElementById('finalUrl').innerText = url;
                    document.getElementById('shareSection').style.display = 'block';
                    if (navigator.share) {
                        try { await navigator.share({ title: `A Message for ${data.n}`, text: `I have a romantic trial for you!`, url: url }); } catch (err) { }
                    } else { navigator.clipboard.writeText(url); showSnackbar("Link copied! ‚ù§Ô∏è"); }
                    confetti({ particleCount: 150, spread: 70 });
                };

                document.getElementById('copyWrapper').onclick = () => {
                    navigator.clipboard.writeText(document.getElementById('finalUrl').innerText);
                    showSnackbar("Link Secured! ‚ù§Ô∏è");
                };
                // ... inside renderForm(langKey) ...

                const appShareBtn = document.getElementById('appShareBtn');
                appShareBtn.onclick = async () => {
                    const t = LANG_DATA[langKey] || LANG_DATA.en;
                    const shareData = {
                        title: t.title,
                        text: `Create your own romantic trial! ${t.title}: ${t.sub}. Built by coding-interface.`,
                        url: window.location.origin + window.location.pathname // Shares the clean URL without ?game= params
                    };

                    if (navigator.share) {
                        try {
                            await navigator.share(shareData);
                            showSnackbar("Opening Share Menu... ‚ù§Ô∏è");
                        } catch (err) {
                            console.log("Share cancelled or failed", err);
                        }
                    } else {
                        // Fallback for desktop browsers
                        navigator.clipboard.writeText(shareData.url);
                        showSnackbar("App Link Copied to Clipboard! üîó");
                    }
                };
            }
            setupAvatarGrid(gridId, hiddenId, def) {
                const grid = document.getElementById(gridId);
                AVATAR_LIST.forEach(s => {
                    const img = document.createElement('img');
                    img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${s}&backgroundColor=ffd1dc`;
                    if (s === def) img.className = 'active';
                    img.onclick = () => { grid.querySelectorAll('img').forEach(i => i.className = ''); img.className = 'active'; document.getElementById(hiddenId).value = s; };
                    grid.appendChild(img);
                });
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }
            init() {
                window.currentScene = this;
                const params = new URLSearchParams(window.location.search);
                try {
                    const gameParam = params.get('game');
                    if (!gameParam) throw new Error('No game parameter');
                    let base64str = gameParam;
                    try { base64str = decodeURIComponent(gameParam); } catch (err) { base64str = gameParam; }
                    const decoded = atob(base64str);
                    const bytes = new Uint8Array(decoded.length);
                    for (let i = 0; i < decoded.length; i++) bytes[i] = decoded.charCodeAt(i);
                    const jsonStr = new TextDecoder().decode(bytes);
                    const data = JSON.parse(jsonStr);
                    this.userData = data;
                    this.t = LANG_DATA[data.l] || LANG_DATA.en;
                    this.langKey = data.l || 'en';
                } catch (e) {
                    this.userData = { l: 'en', cid: "Admirer", n: "Love", av: "Andrea", cav: "Liam", m: "Be mine?" };
                    this.t = LANG_DATA.en;
                    this.langKey = 'en';
                }
                this.highScore = parseInt(localStorage.getItem('trialsOfLove_highScore')) || 0;
                this.itemsList = []; this.collisionRadius = 110; this.gameTimer = 0;
                this.lastDifficultyTier = 0;
            }
            preload() { this.load.svg('partner', `https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=ffccd5`, { width: 300, height: 300 }); }

            create() {

                this.score = 0; this.lovePoints = 0; this.isGamePaused = true;
                this.proposalAccepted = false; this.proposalTriggered = false;
                this.add.graphics().fillGradientStyle(0xe0d8cc, 0xe0d8cc, 0xf9f6f0, 0xf9f6f0, 1).fillRect(0, 0, 1080, 1920);
                this.createRomanticParticles();

                this.scoreText = this.add.text(540, 260, `${this.t.score}: 0`, { fontFamily: 'Cinzel', fontSize: '40px', fill: '#2a241e' }).setOrigin(0.5);
                this.add.text(540, 150, `${this.t.toMy} ${this.userData.n}`, { fontFamily: 'Pinyon Script', fontSize: '100px', fill: '#2a241e' }).setOrigin(0.5);

                this.add.dom(540, 320).createFromHTML(`<div id="meter-container" style="width:500px; height:15px; background:#ccc; border-radius:8px; overflow:hidden;"><div id="fill-bar" style="width:0%; height:100%; background:#d00000; transition:0.3s;"></div></div>`).setDepth(1000);
                this.player = this.add.image(540, 1650, 'partner').setScale(0.8);
                const maskShape = this.make.graphics().fillStyle(0xffffff).fillCircle(0, 0, this.collisionRadius);
                this.player.setMask(maskShape.createGeometryMask());
                this.events.on('update', () => { maskShape.x = this.player.x; maskShape.y = this.player.y; });
                this.input.on('pointermove', (p) => { if (!this.isGamePaused) this.player.x = Phaser.Math.Clamp(p.x, 150, 930); });

                this.refreshSpawnTimer();
                this.showInstructions();
                // FOOTER: Game Scene
                this.add.text(540, 1880, BRANDING_TEXT, { fontFamily: 'Cinzel', fontSize: '24px', fill: '#2a241e' }).setOrigin(0.5).setAlpha(0.6).setDepth(10000);
            }

            createBurst(x, y, content) {
                const count = 12;
                const emoji = (content === "‚ù§Ô∏è") ? "‚ù§Ô∏è" : "‚ú®";
                for (let i = 0; i < count; i++) {
                    const p = this.add.text(x, y, emoji, { fontSize: '40px' }).setOrigin(0.5).setDepth(3000);
                    const angle = Phaser.Math.FloatBetween(0, Math.PI * 2);
                    const speed = Phaser.Math.Between(200, 500);
                    this.tweens.add({ targets: p, x: x + Math.cos(angle) * speed, y: y + Math.sin(angle) * speed, alpha: 0, scale: 0.2, duration: 800, onComplete: () => p.destroy() });
                }
            }

            showInstructions() {
                const html = `<div class="valentine-panel" style="height:auto; min-height:750px; padding:50px; border: 4px solid var(--gold);">
                    <h2 style="font-family:'Cinzel'; font-size:48px; color:var(--gold);">${this.t.ruleT}</h2>
                    <p style="font-family:'Pinyon Script'; font-size:35px;">${this.t.ruleSub}</p>
                    <div style="text-align:left; font-size:26px; line-height:1.5; margin:20px 0;">
                        <p>üèπ ${this.t.ruleMove}</p>
                        <div style="background: rgba(0,128,0,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <p><b>${this.t.ruleCatch}</b></p>
                            <p style="font-size:40px; margin:10px 0;">‚ù§Ô∏è üåπ üß∏ üíç üòò</p>
                        </div>
                        <div style="background: rgba(208,0,0,0.05); padding: 15px; border-radius: 10px;">
                            <p style="color:var(--red);"><b>${this.t.ruleAvoid}</b></p>
                            <p style="font-size:40px; margin:10px 0;">üíî üí£ üòà üíé üí∞</p>
                            <p style="font-size:20px; color:var(--red);">${this.t.ruleWarn}</p>
                        </div>
                    </div>
                    <button id="startBtn" class="ui-button" style="width:100%;">${this.t.begin}</button>
                </div>`;
                const dom = this.add.dom(540, 960).createFromHTML(html).setDepth(5000);
                document.getElementById('startBtn').onclick = () => { dom.destroy(); this.isGamePaused = false; };
            }

            createRomanticParticles() {
                for (let i = 0; i < 40; i++) {
                    const heart = this.add.text(Phaser.Math.Between(0, 1080), Phaser.Math.Between(0, 1920), '‚ù§Ô∏è', { fontSize: Phaser.Math.Between(20, 50) + 'px' });
                    heart.setTint(0xffb6c1).setAlpha(Phaser.Math.FloatBetween(0.1, 0.4)).setDepth(1);
                    this.tweens.add({ targets: heart, x: heart.x + Phaser.Math.Between(-100, 100), y: heart.y + Phaser.Math.Between(-100, 100), alpha: { from: 0.1, to: 0.3 }, duration: Phaser.Math.Between(5000, 10000), yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
                }
            }

            refreshSpawnTimer() {
                if (this.spawnTimer) this.spawnTimer.remove();
                // DIFFICULTY: Delay drops by 50ms every 5 seconds, min 400ms
                const newDelay = Math.max(400, 900 - (Math.floor(this.gameTimer / 5000) * 50));
                this.spawnTimer = this.time.addEvent({ delay: newDelay, loop: true, callback: this.spawnTrajectoryItem, callbackScope: this });
            }

            spawnTrajectoryItem() {
                if (this.isGamePaused) return;

                // Item Distribution Logic
                let pool;
                if (!this.proposalAccepted) {
                    // Phase 1: Hearts are abundant (3 out of 6 slots = 50% chance)
                    pool = ["‚ù§Ô∏è", "‚ù§Ô∏è", "‚ù§Ô∏è", "üåπ", "üß∏", "üíç"];
                } else {
                    // Phase 2: Hearts are rare (1 out of 12 slots = ~8% chance)
                    // We flood the pool with variety and hazards to make the heart a prize
                    pool = ["‚ù§Ô∏è", "üåπ", "üß∏", "üòò", "üíç", "üíî", "üí£", "üòà", "ü•Ä", "üíé", "üí∞", "üåπ"];
                }

                const content = Phaser.Utils.Array.GetRandom(pool);
                const side = Math.random() < 0.5 ? 'left' : 'right';

                // Container setup
                const container = this.add.container(side === 'left' ? -100 : 1130, Phaser.Math.Between(800, 1100));

                // Visual Scaling: Make the rare heart slightly larger to stand out
                const fontSize = content === "‚ù§Ô∏è" ? '120px' : '90px';
                const item = this.add.text(0, 0, content, { fontSize: fontSize }).setOrigin(0.5);
                container.add(item);

                // Glassy Glint for Hearts (Always apply to ‚ù§Ô∏è)
                if (content === "‚ù§Ô∏è") {
                    const glint = this.add.graphics().fillStyle(0xffffff, 0.3).fillEllipse(-20, -25, 45, 20);
                    container.add(glint);
                    this.tweens.add({ targets: container, scale: 1.05, duration: 800, yoyo: true, repeat: -1 });
                }

                // Difficulty Physics
                const speedBoost = Math.min(15, this.gameTimer / 10000);
                container.vx = (side === 'left' ?
                    Phaser.Math.Between(3 + speedBoost, 14 + speedBoost) :
                    Phaser.Math.Between(-14 - speedBoost, -3 - speedBoost));
                container.vy = Phaser.Math.Between(-8 - speedBoost, -12 - speedBoost);

                container.isGood = ["‚ù§Ô∏è", "üåπ", "üß∏", "üòò", "üíç"].includes(content);
                container.content = content;
                container.setDepth(2000);

                this.itemsList.push(container);

                // Difficulty Scaling Check
                if (Math.floor(this.gameTimer / 5000) > this.lastDifficultyTier) {
                    this.lastDifficultyTier = Math.floor(this.gameTimer / 5000);
                    this.refreshSpawnTimer();
                }
            }
            update(time, delta) {
                if (this.isGamePaused) return;
                const dtScale = Math.min(delta, 32) / 16.666;
                this.gameTimer += delta;

                // DIFFICULTY: Gravity increases over time
                const gravityBase = 0.6;
                const gravityIncrease = Math.min(0.5, this.gameTimer / 45000);
                const currentGravity = (gravityBase + gravityIncrease) * dtScale;

                for (let i = this.itemsList.length - 1; i >= 0; i--) {
                    const item = this.itemsList[i];
                    item.x += item.vx * dtScale; item.y += item.vy * dtScale; item.vy += currentGravity;
                    if (Phaser.Math.Distance.Between(item.x, item.y, this.player.x, this.player.y) < this.collisionRadius) {
                        if (item.isGood) {
                            const val = (item.content === "‚ù§Ô∏è" ? 10 : 5); this.score += val;
                            if (item.content === "‚ù§Ô∏è") this.lovePoints = Math.min(5, this.lovePoints + 1);
                            this.createBurst(item.x, item.y, item.content);
                        } else { this.handlePointLoss(); }
                        this.updateUI();
                        if (this.lovePoints >= 5 && !this.proposalTriggered) { this.proposalTriggered = true; this.showProposal(); }
                        item.destroy(); this.itemsList.splice(i, 1);
                    } else if (item.y > 2000) {
                        if (item.isGood) this.handlePointLoss();
                        item.destroy(); this.itemsList.splice(i, 1);
                    }
                }
            }

            handlePointLoss() {
                this.lovePoints = Math.max(0, this.lovePoints - 1);
                this.cameras.main.shake(60, 0.006);
                const flash = this.add.rectangle(540, 960, 1080, 1920, 0xd00000, 0.2).setDepth(5000);
                this.tweens.add({ targets: flash, alpha: 0, duration: 200, onComplete: () => flash.destroy() });
                this.updateUI();
                if (this.proposalAccepted && this.lovePoints <= 0) this.gameOver();
            }

            updateUI() {
                this.scoreText.setText(`${this.t.score}: ${this.score}`);
                const fill = document.getElementById('fill-bar');
                if (fill) fill.style.width = (this.lovePoints * 20) + "%";
                const meterBox = document.getElementById('meter-container');
                if (meterBox && this.lovePoints >= 5) meterBox.classList.add('meter-pulse');
            }

            showProposal() {
                this.isGamePaused = true;
                // ${this.t.from} ${this.userData.cid}
                let msg = this.langKey == "hi" ? `${this.userData.cid} ${this.t.from}` : `${this.t.from} ${this.userData.cid}`;
                const html = `<div class="valentine-panel" style="height:auto; min-height:600px; padding:40px;"><h2 style="font-family:'Cinzel'; color:var(--gold);">${msg}</h2><p style="font-family:'Pinyon Script'; font-size:60px; color:var(--red); margin:40px 0;">${this.userData.m}</p><div style="display:flex; justify-content:center; gap:30px; position:relative; height:120px;"><button id="yes" class="ui-button">${this.t.accept}</button><button id="no" class="ui-button" style="background:#555;">${this.t.decline}</button></div></div>`;
                const dom = this.add.dom(540, 960).createFromHTML(html).setDepth(3000);
                const noBtn = document.getElementById('no');
                noBtn.onmouseover = () => { noBtn.style.position = 'absolute'; noBtn.style.left = (Math.random() * 400 - 200) + 'px'; noBtn.style.top = (Math.random() * 100 - 50) + 'px'; };
                document.getElementById('yes').onclick = () => { dom.destroy(); this.proposalAccepted = true; this.revealIdentity(); };
            }

            revealIdentity() {
                const html = `<div class="valentine-panel" style="height:auto; min-height:700px; padding:50px;"><div style="display:flex; justify-content:center; align-items:center; gap:40px; margin-bottom:30px;"><div style="text-align:center;"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.cav}&backgroundColor=cceeff" style="width:220px; border:5px solid var(--gold); border-radius:50%;"><p style="font-family:'Cinzel'; font-size:28px; margin-top:15px;">${this.userData.cid}</p></div><span style="font-size:90px; animation: pulse-heart 1s infinite alternate;">‚ù§Ô∏è</span><div style="text-align:center;"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=ffccd5" style="width:220px; border:5px solid var(--gold); border-radius:50%;"><p style="font-family:'Cinzel'; font-size:28px; margin-top:15px;">${this.userData.n}</p></div></div><h2 style="font-family:'Cinzel'; font-size:45px;">${this.t.forever}</h2><button id="cont" class="ui-button" style="font-size:32px;">${this.t.protect}</button></div>`;
                const dom = this.add.dom(540, 960).createFromHTML(html).setDepth(3000);
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.7 } });
                document.getElementById('cont').onclick = () => { dom.destroy(); this.isGamePaused = false; };
            }

            gameOver() {
                this.isGamePaused = true;
                if (this.score > this.highScore) { this.highScore = this.score; localStorage.setItem('trialsOfLove_highScore', this.highScore); }
                const html = `<div class="valentine-panel" style="height:auto; min-height:850px; padding:40px; pointer-events: auto !important;">
                    <div style="display:flex; justify-content:center; align-items:center; gap:30px; margin-bottom:20px;"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.cav}&backgroundColor=cceeff" style="width:180px; border:3px solid var(--gold); border-radius:50%;"><span style="font-size:70px;">üíî</span><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=ffccd5" style="width:180px; border:3px solid var(--gold); border-radius:50%;"></div>
                    <h2 style="font-size:50px; margin:0;">${this.t.overwhelmed}</h2>
                    <p style="font-weight:bold; font-size:40px; color:var(--red); margin:10px 0;">Score: ${this.score}</p>
                    <p style="font-family:'Cinzel'; font-size:24px; color:var(--gold);">${this.t.best}: ${this.highScore}</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:30px;"><button onclick="window.location.reload()" class="ui-button">${this.t.renew}</button><button id="shareScoreBtn" class="ui-button">${this.t.share}</button><button id="newProposalBtn" class="ui-button">${this.t.forge}</button><button id="exitGameBtn" class="ui-button" style="background:#555">${this.t.exit}</button></div>
                </div>`;
                const dom = this.add.dom(540, 960).createFromHTML(html).setDepth(6000);
                document.getElementById('shareScoreBtn').onclick = () => { if (navigator.share) navigator.share({ title: 'My Affection', text: `My affection reached ${this.score}! ‚ù§Ô∏è`, url: window.location.origin + window.location.pathname }); };
                document.getElementById('newProposalBtn').onclick = () => { window.location.href = window.location.origin + window.location.pathname; };
                document.getElementById('exitGameBtn').onclick = () => { window.close(); };
            }
        }

        const config = { type: Phaser.AUTO, width: 1080, height: 1920, parent: 'phaser-game', dom: { createContainer: true }, scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH }, scene: [FormScene, GameScene] };
        const gameInstance = new Phaser.Game(config);

        window.addEventListener('load', () => {
            if (new URLSearchParams(window.location.search).has('game')) {
                const check = setInterval(() => { if (gameInstance.scene.isActive('FormScene')) { gameInstance.scene.stop('FormScene'); gameInstance.scene.start('GameScene'); clearInterval(check); } }, 100);
            }
        });
    </script>
</body>

</html>
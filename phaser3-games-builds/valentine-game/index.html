<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Trials of True Love ‚ù§Ô∏è - v3.1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Pinyon+Script&family=Playfair+Display:ital,wght@0,600;1,600&family=Noto+Sans+Devanagari:wght@700&family=Noto+Sans+Bengali:wght@700&family=Noto+Sans+Tamil:wght@700&family=Noto+Sans+Gujarati:wght@700&display=swap');

        :root {
            --glass-bg: rgba(255, 248, 250, 0.95);
            --red: #ff4d6d;
            --deep-pink: #c9184a;
            --soft-pink: #ff758f;
            --gold: #ffb703;
            --ink: #590d22;
            --track-glass: rgba(201, 24, 74, 0.15);
        }

        body {
            margin: 0;
            padding: 0;
            background: #ffe5ec;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 60px;
            padding: 50px 70px;
            width: 850px;
            box-shadow: 0 40px 100px rgba(255, 77, 109, 0.25);
            border: 4px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            pointer-events: auto !important;
        }

        .scroll-box {
            max-height: 350px;
            width: 100%;
            overflow-y: auto;
            padding: 10px;
            margin: 20px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--red) transparent;
        }

        .scroll-box::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-box::-webkit-scrollbar-thumb {
            background: var(--red);
            border-radius: 10px;
        }

        .share-url-container {
            background: rgba(0, 0, 0, 0.05);
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            border: 2px dashed var(--red);
        }

        .url-text-scroll {
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            font-family: monospace;
            font-size: 24px;
            color: var(--ink);
            padding-bottom: 5px;
        }

        .copy-btn {
            color: var(--red);
            font-size: 40px;
            cursor: pointer;
            transition: 0.2s;
        }

        .copy-btn:active {
            transform: scale(0.8);
        }

        .pill-button {
            padding: 30px 50px;
            margin: 12px 0;
            border: none;
            border-radius: 100px;
            font-family: 'Cinzel', sans-serif;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            width: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: white;
            transition: 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--red), var(--deep-pink));
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--soft-pink), var(--red));
        }

        .btn-tertiary {
            background: linear-gradient(135deg, #a4133c, #800f2f);
        }

        .btn-dark {
            background: var(--ink);
        }

        .btn-no-troll {
            background: #444;
            position: absolute;
            transition: 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            width: auto !important;
            padding: 20px 40px !important;
            z-index: 1000;
            font-size: 24px;
        }

        .avatar-frame {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 6px solid white;
            background: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .avatar-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .progress-container {
            width: 750px;
            height: 35px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 40px;
            position: relative;
            margin: 25px auto;
            border: 3px solid white;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff758f, #ff4d6d);
            border-radius: 40px;
            width: 50%;
            transition: width 0.3s ease;
        }

        .hud-circle {
            position: absolute;
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 5;
            top: 50%;
            transform: translateY(-50%);
        }

        .hud-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .partner-marker {
            border: 5px solid var(--red);
            transform: translate(-50%, -50%);
            transition: left 0.3s ease;
        }

        .goal-marker {
            border: 5px solid var(--gold);
            right: -55px;
        }

        .slider-glass {
            width: 850px;
            height: 160px;
            background: var(--track-glass);
            backdrop-filter: blur(25px);
            border-radius: 100px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #playerSlider {
            width: 100%;
            height: 100%;
            background: transparent;
            outline: none;
            z-index: 10;
            position: absolute;
            cursor: pointer;
            -moz-appearance: none;
            -ms-appearance: none;
            -o-appearance: none;
            -webkit-appearance: none;
        }

        #playerSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 150px;
            height: 150px;
            opacity: 0;
        }

        .thumb-anchor {
            position: absolute;
            width: calc(100% - 140px);
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        #customHeartHandle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: white;
            border: 5px solid var(--red);
            border-radius: 50%;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 30px rgba(255, 77, 109, 0.3);
        }

        .ghost-guide-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            display: none;
            place-items: center;
            z-index: 4;
            pointer-events: none;
            border: 4px dotted white;
            border-radius: 50%;
        }

        .tutorial-active {
            display: grid;
            animation: tutorialDrag 2.5s ease-in-out infinite;
        }

        @keyframes tutorialDrag {

            0%,
            100% {
                left: 10%;
                opacity: 0.2;
            }

            50% {
                left: 90%;
                opacity: 0.8;
            }
        }

        .pulse-heart-icon {
            color: var(--red);
            font-size: 70px;
            animation: biometricPulse 0.8s infinite;
        }

        @keyframes biometricPulse {

            0%,
            100% {
                transform: scale(1);
            }

            15% {
                transform: scale(1.15);
            }

            30% {
                transform: scale(1);
            }

            45% {
                transform: scale(1.1);
            }
        }

        .avatar-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            background: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 30px;
            width: 100%;
            margin: 10px 0;
        }

        .lang-dropdown-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 30000;
        }

        .lang-select {
            background: var(--red);
            color: white;
            border: 3px solid white;
            border-radius: 25px;
            padding: 10px 40px 10px 20px;
            font-family: 'Cinzel', sans-serif;
            font-size: 20px;
            cursor: pointer;
            outline: none;
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.3);
            appearance: none;
            -webkit-appearance: none;
        }

        .lang-dropdown-container::after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="phaser-game"></div>
    <div id="snackbar"
        style="visibility:hidden; min-width:250px; background-color:var(--deep-pink); color:#fff; text-align:center; border-radius:50px; padding:16px; position:fixed; z-index:3000; left:50%; bottom:30px; transform:translateX(-50%); font-family:'Cinzel';">
        Link Copied! ‚ù§Ô∏è</div>

    <script>
        const i18n = {
            en: {
                langName: "English",
                font: "'Cinzel', serif",
                scriptFont: "'Pinyon Script', cursive",
                dear: "Dear",
                btn: "‡§π‡§ø‡§Ç‡§¶‡•Ä",
                title: "LOVE TRIAL",
                yourName: "Your Name",
                belovedName: "Beloved's Name",
                msgHint: "Pop a question, make them smile...",
                defaultMsg: "You've captured my heart! Will you be my Valentine? ‚ù§Ô∏è",
                seal: "SEND WITH LOVE",
                shareWithLove: "Share with Love",
                start: "START TRIAL",
                catch: "Catch: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "Avoid: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä",
                affection: "Affection",
                admirerDetails: "Admirer's Details: ",
                yes: "YES! üòç",
                no: "No",
                lost: "Affection Lost",
                tryAgain: "TRY AGAIN",
                share: "SHARE SCORE",
                create: "CREATE NEW",
                exit: "EXIT",
                trolls: ["Too slow!", "Boomer clicks?", "Is that all?", "Click better!", "Try harder!", "Missed me!"],
                copied: "Link Secured! ‚ù§Ô∏è"
            },
            hi: {
                langName: "‡§π‡§ø‡§®‡•ç‡§¶‡•Ä",
                font: "'Noto Sans Devanagari', sans-serif",
                scriptFont: "'Noto Sans Devanagari', sans-serif",
                dear: "‡§™‡•ç‡§∞‡§ø‡§Ø",
                btn: "‡§Æ‡§∞‡§æ‡§†‡•Ä",
                title: "‡§™‡•ç‡§∞‡•á‡§Æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ",
                yourName: "‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ",
                belovedName: "‡§™‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ",
                msgHint: "‡§è‡§ï ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç, ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§Æ‡•Å‡§∏‡•ç‡§ï‡•Å‡§∞‡§æ‡§®‡•á ‡§¶‡•á‡§Ç...",
                defaultMsg: "‡§§‡•Å‡§Æ‡§®‡•á ‡§Æ‡•á‡§∞‡§æ ‡§¶‡§ø‡§≤ ‡§ú‡•Ä‡§§ ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à! ‡§ï‡•ç‡§Ø‡§æ ‡§§‡•Å‡§Æ ‡§Æ‡•á‡§∞‡•á ‡§µ‡•à‡§≤‡•á‡§Ç‡§ü‡§æ‡§á‡§® ‡§¨‡§®‡•ã‡§ó‡•á? ‚ù§Ô∏è",
                seal: "‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§∏‡•á ‡§≠‡•á‡§ú‡•á‡§Ç",
                shareWithLove: "‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§∏‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
                start: "‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
                catch: "‡§™‡§ï‡§°‡§º‡•ã: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "‡§¨‡§ö‡•ã: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä ",
                affection: "‡§∏‡•ç‡§®‡•á‡§π",
                admirerDetails: "‡§™‡•ç‡§∞‡§∂‡§Ç‡§∏‡§ï ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£: ",
                yes: "‡§π‡§æ‡§Å! üòç",
                no: "‡§®‡§π‡•Ä‡§Ç",
                lost: "‡§∏‡•ç‡§®‡•á‡§π ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§",
                tryAgain: "‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç",
                share: "‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
                create: "‡§®‡§Ø‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç",
                exit: "‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡•á‡§Ç",
                trolls: ["‡§¨‡§π‡•Å‡§§ ‡§ß‡•Ä‡§∞‡•á!", "‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•ã?", "‡§¨‡§∏ ‡§á‡§§‡§®‡§æ ‡§π‡•Ä?"],
                copied: "‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ! ‚ù§Ô∏è"
            },
            mr: {
                langName: "‡§Æ‡§∞‡§æ‡§†‡•Ä",
                font: "'Noto Sans Devanagari', sans-serif",
                scriptFont: "'Noto Sans Devanagari', sans-serif",
                dear: "‡§™‡•ç‡§∞‡§ø‡§Ø",
                btn: "‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä",
                title: "‡§™‡•ç‡§∞‡•á‡§Æ ‡§ö‡§æ‡§ö‡§£‡•Ä",
                yourName: "‡§§‡•Å‡§Æ‡§ö‡•á ‡§®‡§æ‡§µ",
                belovedName: "‡§™‡•ç‡§∞‡§ø‡§Ø ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ",
                msgHint: "‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡§æ, ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ ‡§π‡§∏‡§µ‡§æ...",
                defaultMsg: "‡§§‡•Ç ‡§Æ‡§æ‡§ù‡§Ç ‡§π‡•É‡§¶‡§Ø ‡§ú‡§ø‡§Ç‡§ï‡§≤‡§Ç ‡§Ü‡§π‡•á‡§∏! ‡§§‡•Ç ‡§Æ‡§æ‡§ù‡•Ä ‡§µ‡•ç‡§π‡•Ö‡§≤‡•á‡§Ç‡§ü‡§æ‡§à‡§® ‡§π‡•ã‡§∂‡•Ä‡§≤ ‡§ï‡§æ? ‚ù§Ô∏è",
                seal: "‡§™‡•ç‡§∞‡•á‡§Æ‡§æ‡§®‡•á ‡§™‡§æ‡§†‡§µ‡§æ",
                shareWithLove: "‡§™‡•ç‡§∞‡•á‡§Æ‡§æ‡§®‡•á ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ",
                start: "‡§ö‡§æ‡§ö‡§£‡•Ä ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ",
                catch: "‡§™‡§ï‡™°‡™æ: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "‡™µ‡™æ‡™ö‡™æ: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä",
                affection: "‡§™‡•ç‡§∞‡•á‡§Æ",
                admirerDetails: "‡§ö‡§æ‡§π‡§§‡•ç‡§Ø‡§æ‡§ö‡•á ‡§§‡§™‡§∂‡•Ä‡§≤: ",
                yes: "‡§π‡•ã! üòç",
                no: "‡§®‡§æ‡§π‡•Ä",
                lost: "‡§™‡•ç‡§∞‡•á‡§Æ ‡§∏‡§Ç‡§™‡§≤‡•á",
                tryAgain: "‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ",
                share: "‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞ ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ",
                create: "‡§®‡§µ‡•Ä‡§® ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ",
                exit: "‡§¨‡§æ‡§π‡•á‡§∞ ‡§™‡§°‡§æ",
                trolls: ["‡§ñ‡•Ç‡§™ ‡§∏‡•ç‡§≤‡•ã!", "‡§ï‡§æ‡§Ø ‡§ï‡§∞‡§§‡•ã‡§Ø‡§∏?"],
                copied: "‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ù‡§æ‡§≤‡•Ä! ‚ù§Ô∏è"
            },
            gu: {
                langName: "‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä",
                font: "'Noto Sans Gujarati', sans-serif",
                scriptFont: "'Noto Sans Gujarati', sans-serif",
                dear: "‡™µ‡™π‡™æ‡™≤‡™æ",
                btn: "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ",
                title: "‡™™‡´ç‡™∞‡´á‡™Æ ‡™ï‡™∏‡´ã‡™ü‡´Ä",
                yourName: "‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™®‡™æ‡™Æ",
                belovedName: "‡™™‡´ç‡™∞‡™ø‡™Ø‡™®‡´Å‡™Ç ‡™®‡™æ‡™Æ",
                msgHint: "‡™è‡™ï ‡™™‡´ç‡™∞‡™∂‡´ç‡™® ‡™™‡´Ç‡™õ‡´ã, ‡™§‡´á‡™Æ‡™®‡´á ‡™∏‡´ç‡™Æ‡™ø‡™§ ‡™ï‡™∞‡™æ‡™µ‡´ã...",
                defaultMsg: "‡™§‡´á ‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™¶‡™ø‡™≤ ‡™ú‡´Ä‡™§‡´Ä ‡™≤‡´Ä‡™ß‡´Å‡™Ç ‡™õ‡´á! ‡™∂‡´Å‡™Ç ‡™§‡´Å‡™Ç ‡™Æ‡™æ‡™∞‡´Ä ‡™µ‡´á‡™≤‡´á‡™®‡´ç‡™ü‡™æ‡™á‡™® ‡™¨‡™®‡´Ä‡™∂? ‚ù§Ô∏è",
                seal: "‡™™‡´ç‡™∞‡´á‡™Æ‡™•‡´Ä ‡™Æ‡´ã‡™ï‡™≤‡´ã",
                shareWithLove: "‡™™‡´ç‡™∞‡´á‡™Æ‡™•‡´Ä ‡™∂‡´á‡™∞ ‡™ï‡™∞‡´ã",
                start: "‡™ï‡™∏‡´ã‡™ü‡´Ä ‡™∂‡™∞‡´Ç ‡™ï‡™∞‡´ã",
                catch: "‡™™‡™ï‡™°‡´ã: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "‡™¨‡™ö‡´ã: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä",
                affection: "‡™∏‡´ç‡™®‡´á‡™π",
                admirerDetails: "‡™™‡´ç‡™∞‡™∂‡™Ç‡™∏‡™ï‡™®‡´Ä ‡™µ‡™ø‡™ó‡™§‡´ã: ",
                yes: "‡™π‡™æ! üòç",
                no: "‡™®‡™æ",
                lost: "‡™∏‡´ç‡™®‡´á‡™π ‡™∏‡™Æ‡™æ‡™™‡´ç‡™§",
                tryAgain: "‡™´‡™∞‡´Ä ‡™™‡´ç‡™∞‡™Ø‡™æ‡™∏ ‡™ï‡™∞‡´ã",
                share: "‡™∏‡´ç‡™ï‡´ã‡™∞ ‡™∂‡´á‡™∞ ‡™ï‡™∞‡´ã",
                create: "‡™®‡™µ‡´Å‡™Ç ‡™¨‡™®‡™æ‡™µ‡´ã",
                exit: "‡™¨‡™π‡™æ‡™∞ ‡™®‡´Ä‡™ï‡™≥‡´ã",
                trolls: ["‡™¨‡™π‡´Å ‡™ß‡´Ä‡™Æ‡™æ!", "‡™∂‡´Å‡™Ç ‡™ï‡™∞‡´á ‡™õ‡´á?"],
                copied: "‡™≤‡™ø‡™®‡´ç‡™ï ‡™ï‡´ã‡™™‡´Ä ‡™•‡™à! ‚ù§Ô∏è"
            },
            bn: {
                langName: "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ",
                font: "'Noto Sans Bengali', sans-serif",
                scriptFont: "'Noto Sans Bengali', sans-serif",
                dear: "‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º",
                btn: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",
                title: "‡¶™‡ßç‡¶∞‡ßá‡¶Æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ",
                yourName: "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ",
                belovedName: "‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶ú‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ",
                msgHint: "‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶π‡¶æ‡¶∏‡¶æ‡¶§‡ßá ‡¶¶‡¶ø‡¶®...",
                defaultMsg: "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶® ‡¶ú‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá‡¶õ‡ßã! ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶á‡¶® ‡¶π‡¶¨‡ßá? ‚ù§Ô∏è",
                seal: "‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®",
                shareWithLove: "‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
                start: "‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®",
                catch: "‡¶ß‡¶∞‡ßÅ‡¶®: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "‡¶¨‡¶æ‡¶Å‡¶ö‡ßÅ‡¶®: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä",
                affection: "‡¶∏‡ßç‡¶®‡ßá‡¶π",
                admirerDetails: "‡¶™‡ßç‡¶∞‡¶∂‡¶Ç‡¶∏‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£: ",
                yes: "‡¶π‡ßç‡¶Ø‡¶æ‡¶Å! üòç",
                no: "‡¶®‡¶æ",
                lost: "‡¶∏‡ßç‡¶®‡ßá‡¶π ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§",
                tryAgain: "‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®",
                share: "‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
                create: "‡¶®‡¶§‡ßÅ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®",
                exit: "‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®",
                trolls: ["‡¶ñ‡ßÅ‡¶¨ ‡¶ß‡ßÄ‡¶∞!", "‡¶ï‡¶ø ‡¶ï‡¶∞‡¶õ‡ßã?"],
                copied: "‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‚ù§Ô∏è"
            },
            ta: {
                langName: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",
                font: "'Noto Sans Tamil', sans-serif",
                scriptFont: "'Noto Sans Tamil', sans-serif",
                dear: "‡ÆÖ‡Æ©‡Øç‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥",
                btn: "English",
                title: "‡Æï‡Ææ‡Æ§‡Æ≤‡Øç ‡Æö‡Øã‡Æ§‡Æ©‡Øà",
                yourName: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
                belovedName: "‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
                msgHint: "‡Æí‡Æ∞‡ØÅ ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà‡Æï‡Øç ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡ÆÖ‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡Æö‡Æø‡Æ∞‡Æø‡Æï‡Øç‡Æï ‡Æµ‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç...",
                defaultMsg: "‡Æé‡Æ©‡Øç ‡Æá‡Æ§‡ÆØ‡Æ§‡Øç‡Æ§‡Øà ‡Æµ‡ØÜ‡Æ©‡Øç‡Æ±‡ØÅ‡Æµ‡Æø‡Æü‡Øç‡Æü‡Ææ‡ÆØ‡Øç! ‡Æ®‡ØÄ ‡Æé‡Æ©‡Øç ‡Æï‡Ææ‡Æ§‡Æ≤‡Æø‡ÆØ‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Ææ? ‚ù§Ô∏è",
                seal: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç",
                shareWithLove: "‡ÆÖ‡Æ©‡Øç‡Æ™‡ØÅ‡Æü‡Æ©‡Øç ‡Æ™‡Æï‡Æø‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç",
                start: "‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ",
                catch: "‡Æ™‡Æø‡Æü‡Æø: ‚ù§Ô∏è üíê üåπ üß∏ üç´ üç©",
                avoid: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç: üï∑Ô∏è ü™≥ üßü üí£ ü¶Ç ü•Ä",
                affection: "‡ÆÖ‡Æ©‡Øç‡Æ™‡ØÅ",
                admirerDetails: "‡Æ∞‡Æö‡Æø‡Æï‡Æ∞‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç: ",
                yes: "‡ÆÜ‡ÆÆ‡Øç! üòç",
                no: "‡Æá‡Æ≤‡Øç‡Æ≤‡Øà",
                lost: "‡ÆÖ‡Æ©‡Øç‡Æ™‡ØÅ ‡Æï‡ØÅ‡Æ±‡Øà‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ",
                tryAgain: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ≤‡Øç‡Æï",
                share: "‡Æ™‡Æï‡Æø‡Æ∞‡Øç",
                create: "‡Æ™‡ØÅ‡Æ§‡Æø‡Æ§‡Ææ‡Æï ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ",
                exit: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ",
                trolls: ["‡ÆÆ‡Æø‡Æï ‡ÆÆ‡ØÜ‡Æ§‡ØÅ!", "‡Æé‡Æ©‡Øç‡Æ© ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Ææ‡ÆØ‡Øç?"],
                copied: "‡Æ≤‡Æø‡Æô‡Øç‡Æï‡Øç ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡Æø ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ! ‚ù§Ô∏è"
            }
        };

        let langOrder = ['en', 'hi', 'mr', 'gu', 'bn', 'ta'];
        let currentLangIdx = 0;
        let currentLang = 'en';

        // UTF-8 Safe Decoding Helper
        function decodeSafeData(base64) {
            try {
                const utf8Data = atob(base64).split('').map((c) => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('');
                return JSON.parse(decodeURIComponent(utf8Data));
            } catch (e) { return null; }
        }


        function addNativeFooter(scene) {
            scene.add.text(540, 1890, 'version:1.1.0 ¬© 2026 Coding Interface', {
                fontFamily: 'Playfair Display', fontSize: '22px', color: '#590d22', alpha: 0.6
            }).setOrigin(0.5).setDepth(30000);
        }

        function addNativeLangDropdown(scene) {
            const dict = i18n[currentLang];

            // Increased padding (15px 50px) and font-size (26px) for better touch targets
            const html = `
        <div class="lang-dropdown-container" style="position: relative; top: 0; right: 0;">
            <select class="lang-select" id="langSelectElement" 
                style="padding: 15px 55px 15px 25px; font-size: 26px; border-radius: 35px; min-width: 180px;">
                ${langOrder.map(langCode => `
                    <option value="${langCode}" ${langCode === currentLang ? 'selected' : ''}>
                        ${i18n[langCode].langName}
                    </option>
                `).join('')}
            </select>
        </div>
    `;

            // Adjusted coordinates slightly (930, 80) to account for the larger size
            const langDom = scene.add.dom(930, 80).createFromHTML(html);

            const select = document.getElementById('langSelectElement');
            select.onchange = (e) => {
                currentLang = e.target.value;
                currentLangIdx = langOrder.indexOf(currentLang);
                window.game.scene.getScenes(true).forEach(s => {
                    if (s.refreshUI) s.refreshUI();
                });
            };

            return langDom;
        }
        class FormScene extends Phaser.Scene {
            constructor() { super('FormScene'); }
            init() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('game')) {
                    const gameData = decodeSafeData(urlParams.get('game'));
                    if (gameData) {
                        currentLang = gameData.l;
                        currentLangIdx = langOrder.indexOf(currentLang);
                        this.scene.start('GameScene', { gameData });
                        return;
                    }
                }

                // if (urlParamsInitial.has('game')) {
                //     const decoded = decodeSafeData(urlParamsInitial.get('game'));
                //     if (decoded && decoded.l && langOrder.includes(decoded.l)) {
                //         currentLang = decoded.l;
                //         currentLangIdx = langOrder.indexOf(currentLang);
                //     }
                // }

            }
            preload() {
                this.load.image('gameLogo', 'logo.png');
            }
            create() {
                const params = new URLSearchParams(window.location.search);
                if (params.has('game')) { this.scene.start('GameScene'); return; }
                this.add.graphics().fillGradientStyle(0xffe5ec, 0xffe5ec, 0xfff0f3, 0xfff0f3, 1).fillRect(0, 0, 1080, 1920);
                // Replace the old call with:
                addNativeLangDropdown(this);
                addNativeFooter(this);

                if (this.textures.exists('gameLogo')) {
                    const logo = this.add.image(540, 280, 'gameLogo').setOrigin(0.5).setScale(0.5).setAlpha(0.95);
                    this.tweens.add({
                        targets: logo,
                        scale: 0.58,
                        duration: 1500,
                        yoyo: true,
                        repeat: -1,
                        ease: 'Sine.easeInOut'
                    });
                }

                this.createAmbientHearts();
                this.renderForm();
            }
            refreshUI() { this.renderForm(); }
            burstHearts() {
                for (let i = 0; i < 20; i++) {
                    const heart = this.add.text(540, 960, '‚ù§Ô∏è', { fontSize: '60px' }).setOrigin(0.5).setDepth(3000);
                    this.tweens.add({ targets: heart, x: Phaser.Math.Between(0, 1080), y: Phaser.Math.Between(0, 1920), alpha: 0, scale: 2.5, duration: 1500, onComplete: () => heart.destroy() });
                }
            }
            renderForm() {
                // 1. Capture any text the user already typed before we destroy the old DOM
                const existingMsg = document.getElementById('pMsg')?.value;
                const existingYourName = document.getElementById('cID')?.value;
                const existingBelovedName = document.getElementById('pName')?.value;
                const existingPAvatar = document.getElementById('pAvatar')?.value;
                const existingCAvatar = document.getElementById('cAvatar')?.value;

                if (this.formDom) this.formDom.destroy();

                const dict = i18n[currentLang];

                // 2. Logic: If user hasn't typed anything, use the localized default question
                // If they have typed something, keep their custom message
                const textToDisplay = (existingMsg && existingMsg !== "") ? existingMsg : dict.defaultMsg;

                const html = `
    <div class="glass-panel" id="formPanel">
        <h1 style="font-family:${dict.font}; font-size:75px; color:var(--red); margin:0;">${dict.title}</h1>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%; margin:20px 0;">
            <input type="text" id="cID" placeholder="${dict.yourName}" 
                value="${existingYourName || ''}"
                style="padding:22px; border-radius:20px; border:2px solid #ffccd5; font-size:28px;">
            <input type="text" id="pName" maxlength="12" placeholder="${dict.belovedName}" 
                value="${existingBelovedName || ''}"
                style="padding:22px; border-radius:20px; border:2px solid #ffccd5; font-size:28px;">
        </div>
        
        <textarea id="pMsg" rows="3" placeholder="${dict.msgHint}" 
            style="width:100%; padding:22px; border-radius:15px; border:2px solid #ffccd5; font-size:28px; margin-bottom:20px; resize:none; font-family:inherit;">${textToDisplay}</textarea>
        
        <div id="pro-av" class="avatar-scroll"></div>
        <div id="bel-av" class="avatar-scroll"></div>
        
        <button id="genBtn" class="pill-button btn-primary" style="font-family:${dict.font};">
            <i class="fa-solid fa-paper-plane"></i> ${dict.seal}
        </button>
        
        <input type="hidden" id="pAvatar" value="${existingPAvatar || 'Andrea'}">
        <input type="hidden" id="cAvatar" value="${existingCAvatar || 'Liam'}">
    </div>`;

                this.formDom = this.add.dom(540, 960).createFromHTML(html);

                // 3. Re-initialize scrolls with the existing or default selections
                this.setupScroll('pro-av', 'cAvatar', existingCAvatar || 'Liam');
                this.setupScroll('bel-av', 'pAvatar', existingPAvatar || 'Andrea');

                // 4. Handle the URL generation and sharing
                document.getElementById('genBtn').onclick = async () => {
                    const data = {
                        l: currentLang,
                        cid: document.getElementById('cID').value || "Admirer",
                        n: document.getElementById('pName').value || "Love",
                        av: document.getElementById('pAvatar').value,
                        cav: document.getElementById('cAvatar').value,
                        m: document.getElementById('pMsg').value || dict.defaultMsg
                    };

                    // UTF-8 Safe Base64 Encoding
                    const jsonStr = JSON.stringify(data);
                    const utf8Data = encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                        return String.fromCharCode('0x' + p1);
                    });
                    const base64Game = btoa(utf8Data);

                    const url = window.location.origin + window.location.pathname + '?game=' + base64Game;

                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: dict.title,
                                text: `${dict.dear} ${data.n}, Check this secret message Trial of Love! ‚ù§Ô∏è`,
                                url: url,
                            });
                        } catch (err) {
                            this.showFallbackShare(url, data.n);
                        }
                    } else {
                        this.showFallbackShare(url, data.n);
                    }
                };
            }
            async showFallbackShare(url, name) {
                const dict = i18n[currentLang];
                document.getElementById('formPanel').innerHTML = `<h2 style="font-family:${dict.font}; color:var(--red); font-size:50px;">SHARE LINK</h2><button id="sendDirect" class="pill-button btn-primary" style="margin-top:20px; font-family:${dict.font};"><i class="fa-solid fa-share-nodes"></i> ${dict.shareWithLove}</button><div class="share-url-container"><div class="url-text-scroll">${url}</div><i class="fa-solid fa-copy copy-btn" id="copyAction"></i></div><button onclick="window.location.reload()" class="pill-button btn-secondary" style="font-family:${dict.font};">BACK</button>`;

                document.getElementById('copyAction').onclick = () => {
                    const urlToCopy = url;

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(urlToCopy).then(() => {
                            this.showLinkCopiedFeedback();
                        });
                    } else {
                        const textArea = document.createElement("textarea");
                        textArea.value = urlToCopy;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        textArea.style.top = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            if (document.execCommand('copy')) this.showLinkCopiedFeedback();
                        } catch (err) { }
                        document.body.removeChild(textArea);
                    }
                };

                document.getElementById('sendDirect').onclick = async () => {
                    this.burstHearts();
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: dict.title,
                                text: `${dict.dear} ${data.n}, Check this secret message Trial of Love! ‚ù§Ô∏è`,
                                url: url,
                            });
                        } catch (err) {

                        }
                    } else {
                        window.open(`https://wa.me/?text=${encodeURIComponent(url)}`);
                    }

                };
            }

            showLinkCopiedFeedback() {
                const sb = document.getElementById("snackbar");
                sb.innerText = i18n[currentLang].copied;
                sb.style.visibility = "visible";
                setTimeout(() => sb.style.visibility = "hidden", 3000);
            }

            createAmbientHearts() { for (let i = 0; i < 40; i++) { const heart = this.add.text(Phaser.Math.Between(0, 1080), Phaser.Math.Between(0, 1920), 'üíó', { fontSize: Phaser.Math.Between(30, 60) + 'px' }).setAlpha(0.12).setOrigin(0.5); this.tweens.add({ targets: heart, y: heart.y - 1920, duration: Phaser.Math.Between(10000, 20000), repeat: -1 }); } }
            setupScroll(id, hId, def) {
                const ALL_AVATARS = ['Liam', 'Jack', 'Leo', 'Milo', 'Felix', 'Max', 'Finn', 'George', 'Henry', 'Arthur', 'Oscar', 'Jasper', 'Andrea', 'Emma', 'Mia', 'Luna', 'Lily', 'Zoe', 'Chloe', 'Ruby', 'Maya', 'Sophie', 'Alice', 'Clara', 'Grace', 'Ivy', 'Jade', 'Nora', 'Rose'];
                const c = document.getElementById(id);
                ALL_AVATARS.forEach(s => {
                    const frame = document.createElement('div'); frame.className = 'avatar-frame'; if (s === def) frame.style.borderColor = "#ff4d6d";
                    const img = document.createElement('img'); img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${s}&backgroundColor=transparent`;
                    frame.appendChild(img); frame.onclick = () => { Array.from(c.children).forEach(i => i.style.borderColor = 'white'); frame.style.borderColor = "#ff4d6d"; document.getElementById(hId).value = s; };
                    c.appendChild(frame);
                });
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }
            init() {
                const params = new URLSearchParams(window.location.search);
                const decoded = decodeSafeData(params.get('game'));
                this.userData = decoded || { cid: "Admirer", n: "Love", av: "Andrea", cav: "Liam", m: "‚ù§Ô∏è" };
                this.itemsList = []; this.score = 0; this.lovePoints = 2.5; this.isGamePaused = true; this.isOver = false; this.proposalAccepted = false; this.elapsedSeconds = 0;
                this.sprayTimer = null;
            }
            preload() { this.load.svg('partner', `https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=transparent`, { width: 300, height: 300 }); }
            create() {
                this.bgGlow = this.add.graphics().setDepth(0); this.updateBg();
                addNativeLangDropdown(this);
                addNativeFooter(this);
                this.createAmbientHearts();
                // Store references to the text objects
                this.scoreText = this.add.text(540, 260, `${i18n[currentLang].affection}: ${this.score}`, {
                    fontFamily: i18n[currentLang].font,
                    fontSize: '60px',
                    color: '#590d22'
                }).setOrigin(0.5).setDepth(2);
                const titleSize = currentLang === 'en' ? '110px' : '85px';
                this.sceneTitle = this.add.text(540, 140, `${i18n[currentLang].dear} ${this.userData.n}`, {
                    fontFamily: i18n[currentLang].scriptFont,
                    fontSize: titleSize,
                    color: '#ff4d6d'
                }).setOrigin(0.5).setDepth(2);
                this.add.dom(540, 360).createFromHTML(`<div class="progress-container"><div id="fill-bar" class="progress-bar"></div><div id="partner-marker" class="hud-circle partner-marker" style="left:50%"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=transparent"></div><div class="hud-circle goal-marker"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.cav}&backgroundColor=transparent"></div></div>`).setDepth(2);
                this.player = this.add.image(540, 1550, 'partner').setScale(0.78).setDepth(10);
                const mask = this.make.graphics().fillCircle(0, 0, 110); this.player.setMask(mask.createGeometryMask());
                const bubble = this.add.graphics().setDepth(9);
                this.updateBubble = () => { bubble.clear().fillStyle(0xffffff, 1).lineStyle(6, 0xff4d6d, 1).fillCircle(this.player.x, this.player.y, 115).strokeCircle(this.player.x, this.player.y, 115); mask.setPosition(this.player.x, this.player.y); };
                this.add.dom(540, 1780).createFromHTML(`<div class="slider-glass"><input type="range" min="0" max="1000" value="500" id="playerSlider"><div class="thumb-anchor"><div id="ghostGuide" class="ghost-guide-container"><i class="fa-solid fa-hand-pointer" style="color:white; font-size:80px;"></i></div><div id="customHeartHandle"><i class="fa-solid fa-heart-pulse pulse-heart-icon"></i></div></div></div>`).setDepth(100);
                const slider = document.getElementById('playerSlider');
                slider.oninput = (e) => {
                    const percent = e.target.value / 1000;
                    this.player.x = 150 + (percent * 780); this.updateBubble();
                    document.getElementById('customHeartHandle').style.left = (percent * 100) + "%";
                    const ghost = document.getElementById('ghostGuide'); if (ghost) ghost.classList.remove('tutorial-active');
                };
                this.updateBubble(); this.animatePopup();
            }
            updateBg() {
                this.bgGlow.clear().fillGradientStyle(0xffe5ec, 0xffe5ec, 0xfff0f3, 0xfff0f3, 1).fillRect(0, 0, 1080, 1920);
                if (this.lovePoints < 1 && !this.isOver) { const alpha = (Math.sin(this.time.now / 150) + 1) / 4; this.bgGlow.fillStyle(0xff4d6d, alpha).fillRect(0, 0, 1080, 1920); }
            }
            refreshUI() {
                const dict = i18n[currentLang];

                // 1. Update Score Text
                if (this.scoreText) {
                    this.scoreText.setText(`${dict.affection}: ${this.score}`);
                    this.scoreText.setFontFamily(dict.font);
                }

                // 2. Update Title (Dear [Name])
                if (this.sceneTitle) {
                    this.sceneTitle.setText(`${dict.dear} ${this.userData.n}`);
                    this.sceneTitle.setFontFamily(dict.scriptFont);
                    this.sceneTitle.setFontSize(currentLang === 'en' ? '110px' : '85px');
                }

                // 3. Update Instructions Popup if it's currently visible
                if (this.popupDom) {
                    this.animatePopup(); // This will recreate the popup with the new language
                }

                // 4. Update Game Over or Proposal screens if they are active
                if (this.isOver) {
                    this.gameOver();
                } else if (this.isGamePaused && !this.popupDom) {
                    this.showProposal();
                }
            }
            createAmbientHearts() { for (let i = 0; i < 30; i++) { const heart = this.add.text(Phaser.Math.Between(0, 1080), Phaser.Math.Between(0, 1920), 'üíó', { fontSize: Phaser.Math.Between(30, 60) + 'px' }).setAlpha(0.12).setOrigin(0.5); this.tweens.add({ targets: heart, y: heart.y - 1920, duration: Phaser.Math.Between(20000, 50000), repeat: -1 }); } }
            animatePopup() {
                if (this.popupDom) this.popupDom.destroy();
                const dict = i18n[currentLang];
                const html = `<div class="glass-panel"><h2 style="font-family:${dict.font}; font-size:65px; color:var(--red); margin:0;">${dict.title}</h2><div style="background:rgba(255,255,255,0.5); padding:35px; border-radius:40px; margin:30px 0; font-size:42px; font-weight:bold;"><p style="color:var(--deep-pink);">${dict.catch}</p><p style="color:var(--ink);">${dict.avoid}</p></div><button id="startBtn" class="pill-button btn-primary" style="font-family:${dict.font};"><i class="fa-solid fa-heart-pulse"></i> ${dict.start}</button></div>`;
                this.popupDom = this.add.dom(540, 960).createFromHTML(html);
                document.getElementById('startBtn').onclick = () => {
                    this.popupDom.destroy(); this.popupDom = null;
                    this.isGamePaused = false;
                    const ghost = document.getElementById('ghostGuide');
                    if (ghost) ghost.classList.add('tutorial-active');
                    this.time.addEvent({ delay: 1200, loop: true, callback: () => this.elapsedSeconds++ });
                    this.spawnLoop();
                };
            }
            spawnLoop() { if (this.isOver) return; this.spawnItem(); const currentDelay = Math.max(450, 1300 - (this.elapsedSeconds * 12)); this.time.delayedCall(currentDelay, this.spawnLoop, [], this); }
            spawnItem() {
                if (this.isGamePaused || this.isOver) return;

                // 1. RARITY LOGIC: Red Heart gets rare (min 2%)
                const heartWeight = Math.max(2, 40 - (this.elapsedSeconds * 0.4));
                const dangerWeight = Math.min(60, 20 + (this.elapsedSeconds * 0.5));

                const rolls = Math.random() * 100;
                const goodOnes = ["‚ù§Ô∏è", "üíê", "üß∏", "üåπ", 'üç´', 'üç©'];
                const badOnes = ["üï∑Ô∏è", "ü™≥", "üßü‚Äç‚ôÄÔ∏è", "üßü‚Äç‚ôÇÔ∏è", "üí£", "ü¶Ç", "ü•Ä"];

                let content;
                let isGood = true;

                if (rolls < heartWeight) {
                    content = "‚ù§Ô∏è";
                } else if (rolls < (heartWeight + dangerWeight)) {
                    content = Phaser.Utils.Array.GetRandom(badOnes);
                    isGood = false;
                } else {
                    content = Phaser.Utils.Array.GetRandom(goodOnes.filter(e => e !== "‚ù§Ô∏è"));
                    isGood = true;
                }

                const side = Math.random() < 0.5 ? -100 : 1180;
                const item = this.add.text(side, Phaser.Math.Between(400, 800), content, {
                    fontSize: content === "‚ù§Ô∏è" ? '140px' : '110px',
                    stroke: isGood ? '#ffffff' : '#000000',
                    strokeThickness: isGood ? 10 : 0
                }).setOrigin(0.5).setDepth(5);

                // 2. SMART SPEED SCALING: 
                // We increase Vertical Speed (vy) and Gravity to make items fall faster.
                // We keep Horizontal Speed (vx) stable or slightly inward-pointing 
                // to ensure they cross the player's path.

                const speedFactor = 1 + (this.elapsedSeconds * 0.015); // Gradual increase

                // Inward velocity: if starting from left (-100), push right. If right (1180), push left.
                // We don't scale vx with speedFactor to prevent items flying off-screen.
                item.vx = side < 0 ? Phaser.Math.Between(6, 9) : Phaser.Math.Between(-9, -6);

                // Vertical velocity and gravity scale up, making the "window" to catch them smaller
                item.vy = Phaser.Math.Between(-20, -14) * speedFactor;
                item.gravity = 0.45 + (this.elapsedSeconds * 0.008);

                item.angularVelocity = Phaser.Math.Between(-8, 8);
                item.isGood = isGood;
                this.itemsList.push(item);
            }
            update() {
                if (this.isGamePaused || this.isOver) return;
                this.updateBg();
                for (let i = this.itemsList.length - 1; i >= 0; i--) {
                    const it = this.itemsList[i]; it.x += it.vx; it.vy += it.gravity; it.y += it.vy; it.angle += it.angularVelocity;
                    if (Phaser.Math.Distance.Between(it.x, it.y, this.player.x, this.player.y) < 135) { this.handleCatch(it); it.destroy(); this.itemsList.splice(i, 1); }
                    else if (it.y > 2000) { if (it.isGood) this.lovePoints -= 0.4; this.updateUI(); it.destroy(); this.itemsList.splice(i, 1); }
                }
                if (this.lovePoints <= 0) this.gameOver();
            }
            handleCatch(it) {
                if (this.isOver) return;
                const emojis = it.isGood ? ["‚ù§Ô∏è", "‚ú®", "üíñ", "üåπ"] : ["‚ò†Ô∏è", "üï∑Ô∏è", "üíî", "ü•Ä"];
                for (let i = 0; i < 12; i++) { const p = this.add.text(it.x, it.y, Phaser.Utils.Array.GetRandom(emojis), { fontSize: '45px' }).setOrigin(0.5); this.tweens.add({ targets: p, x: p.x + Phaser.Math.Between(-350, 350), y: p.y + Phaser.Math.Between(-350, 350), alpha: 0, angle: Phaser.Math.Between(-180, 180), duration: 800, onComplete: () => p.destroy() }); }
                if (!it.isGood) this.cameras.main.shake(150, 0.012);
                this.score += it.text === "‚ù§Ô∏è" ? 25 : (it.isGood ? 10 : 0);
                this.lovePoints = Math.min(5, this.lovePoints + (it.text === "‚ù§Ô∏è" ? 0.8 : (it.isGood ? 0.4 : -1.0)));
                this.updateUI(); if (this.lovePoints >= 5 && !this.proposalAccepted) { this.isGamePaused = true; this.showProposal(); }
            }
            updateUI() {
                const fb = document.getElementById('fill-bar'); const m = document.getElementById('partner-marker');
                if (fb && m) { const p = Math.max(0, this.lovePoints * 20); fb.style.width = p + "%"; m.style.left = p + "%"; }
                this.scoreText.setText(`${i18n[currentLang].affection}: ${this.score}`);

                if (this.sprayTimer) {
                    const dynamicDelay = 350 - (this.lovePoints * 60);
                    this.sprayTimer.delay = Math.max(50, dynamicDelay);
                }
            }
            showProposal() {
                if (this.propDom) this.propDom.destroy();
                const dict = i18n[currentLang];
                if (this.overlay) this.overlay.destroy();
                this.overlay = this.add.graphics().fillStyle(0x000000, 0.4).fillRect(0, 0, 1080, 1920).setDepth(150);

                const html = `<div class="glass-panel" id="proposalPanel" style="z-index: 200; position: relative;">
        <h2 style="font-family:${dict.font}; color:var(--ink); font-size:45px;">${dict.admirerDetails}${this.userData.cid}</h2>
        <div class="scroll-box">
            <p style="font-family:${dict.scriptFont}; font-size:80px; color:var(--red); line-height:1.2; margin:0;">${this.userData.m}</p>
        </div>
        <div style="display: flex; gap: 20px; width: 100%; justify-content: center; position: relative; height: 150px; margin-top: 10px;">
            <button id="yesBtn" class="pill-button btn-primary" style="width: 350px; font-family:${dict.font};">${dict.yes}</button>
            <button id="noBtn" class="pill-button btn-no-troll" style="width: 250px; position: absolute; left: 55%; font-family:${dict.font};">${dict.no}</button>
        </div>
    </div>`;

                this.propDom = this.add.dom(540, 960).createFromHTML(html).setDepth(200);

                const noBtn = document.getElementById('noBtn');
                const yesBtn = document.getElementById('yesBtn');
                let trollCount = 0;

                noBtn.onmouseover = noBtn.ontouchstart = () => {
                    trollCount++;
                    const newX = Math.random() * 500 - 250;
                    const newY = Math.random() * 300 - 150;
                    noBtn.style.transform = `translate(${newX}px, ${newY}px)`;
                    noBtn.innerText = dict.trolls[trollCount % dict.trolls.length];

                    if (trollCount > 5) yesBtn.style.transform = `scale(${1 + (trollCount * 0.1)})`;

                    if (trollCount > 10) {
                        noBtn.innerText = currentLang === 'en' ? "Fine, Yes!" : (currentLang === 'hi' ? "‡§†‡•Ä‡§ï ‡§π‡•à, ‡§π‡§æ‡§Å!" : (currentLang === 'mr' ? "‡§†‡•Ä‡§ï ‡§Ü‡§π‡•á, ‡§π‡•ã!" : "Fine, Yes!"));
                        noBtn.onclick = yesBtn.onclick;
                    }
                };

                yesBtn.onclick = () => {
                    this.overlay.destroy();
                    this.propDom.destroy();
                    this.propDom = null;
                    this.proposalAccepted = true;
                    this.isGamePaused = false;
                    confetti();

                    this.sprayTimer = this.time.addEvent({
                        delay: 150, loop: true, callback: () => {
                            if (this.isOver) return;
                            const p = this.add.text(930, 360, Phaser.Utils.Array.GetRandom(['‚ù§Ô∏è', '‚ú®', 'üíñ', 'üåπ']), { fontSize: '50px' }).setOrigin(0.5);
                            this.tweens.add({ targets: p, y: -100, x: p.x + Phaser.Math.Between(-150, 150), alpha: 0, duration: 2500, onComplete: () => p.destroy() });
                        }
                    });
                };
            }
            gameOver() {
                if (this.sprayTimer) {
                    this.sprayTimer.remove();
                    this.sprayTimer = null;
                }

                this.isGamePaused = true; this.isOver = true;
                this.updateBg();
                if (this.gameOverDom) this.gameOverDom.destroy();
                if (this.overlay) this.overlay.destroy();
                const dict = i18n[currentLang];
                this.overlay = this.add.graphics().fillStyle(0x000000, 0.4).fillRect(0, 0, 1080, 1920).setDepth(150);
                const pAv = `https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.av}&backgroundColor=transparent`;
                const mAv = `https://api.dicebear.com/7.x/adventurer/svg?seed=${this.userData.cav}&backgroundColor=transparent`;
                const html = `<div class="glass-panel">
                    <h2 style="font-family:${dict.font}; font-size:80px; color:var(--red); margin:0;">${dict.lost}</h2>
                    <div style="display:flex; align-items:center; gap:40px; margin:40px 0;">
                        <div class="avatar-frame"><img src="${pAv}"></div><span style="font-size:120px;">üíî</span><div class="avatar-frame"><img src="${mAv}"></div>
                    </div>
                    <button onclick="window.location.reload()" class="pill-button btn-primary" style="font-family:${dict.font};"><i class="fa-solid fa-rotate-left"></i> ${dict.tryAgain}</button>
                    <button id="invShare" class="pill-button btn-secondary" style="font-family:${dict.font};"><i class="fa-solid fa-share-nodes"></i> ${dict.share}</button>
                    <button onclick="window.location.href=window.location.origin+window.location.pathname" class="pill-button btn-tertiary" style="font-family:${dict.font};"><i class="fa-solid fa-pen-fancy"></i> ${dict.create}</button>
                    <button onclick="window.location.href='https://google.com'" class="pill-button btn-dark" style="font-family:${dict.font};"><i class="fa-solid fa-door-open"></i> ${dict.exit}</button>
                </div>`;
                this.gameOverDom = this.add.dom(540, 960).createFromHTML(html).setScale(0).setDepth(300);
                this.tweens.add({ targets: this.gameOverDom, scale: 1, duration: 500, ease: 'Back.easeOut' });

                document.getElementById('invShare').onclick = async () => {
                    const txt = `${i18n[currentLang].affection} Trial Score: ${this.score}! ‚ù§Ô∏è Check out this secret message for you: `;
                    const my_profile_link = 'https://www.instagram.com/codinginterface?igsh=anVuY3JlYzJ5cWhy&utm_source=qr'
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: dict.title,
                                text: txt,
                                url: my_profile_link,
                            });
                        } catch (err) { console.log("System Share cancelled"); }
                    } else {
                        window.open(`https://wa.me/?text=${encodeURIComponent(txt + " " + my_profile_link)}`);
                    }
                };
            }
        }

        window.onload = () => {
            document.getElementById('snackbar').style.visibility = 'hidden';
            // const urlParamsInitial = new URLSearchParams(window.location.search);
            window.game = new Phaser.Game({ type: Phaser.AUTO, width: 1080, height: 1920, parent: 'phaser-game', dom: { createContainer: true }, scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH }, scene: [FormScene, GameScene] });
        };
    </script>
</body>

</html>